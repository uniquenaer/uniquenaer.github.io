<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="referrer" content="never">
    <title>消息推送和行为日志</title>
    <meta name="description" content="兽人永不为奴~~~除非包吃又包住～～～">
    <link rel="icon" href="/logo.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.32b66682.css" as="style"><link rel="preload" href="/assets/js/app.3184a6a2.js" as="script"><link rel="preload" href="/assets/js/43.70b2f705.js" as="script"><link rel="preload" href="/assets/js/5.4adea544.js" as="script"><link rel="prefetch" href="/assets/js/20.92fe233b.js"><link rel="prefetch" href="/assets/js/2.d62d4ff9.js"><link rel="prefetch" href="/assets/js/3.802dab0f.js"><link rel="prefetch" href="/assets/js/4.dbcc2adb.js"><link rel="prefetch" href="/assets/js/6.58de709a.js"><link rel="prefetch" href="/assets/js/7.a5a75c7e.js"><link rel="prefetch" href="/assets/js/8.7f2e495a.js"><link rel="prefetch" href="/assets/js/9.1291fa0e.js"><link rel="prefetch" href="/assets/js/10.2fabea8f.js"><link rel="prefetch" href="/assets/js/11.bb28ef39.js"><link rel="prefetch" href="/assets/js/12.6df783fa.js"><link rel="prefetch" href="/assets/js/13.fa4956cb.js"><link rel="prefetch" href="/assets/js/14.0df9074c.js"><link rel="prefetch" href="/assets/js/15.ce06c09b.js"><link rel="prefetch" href="/assets/js/16.efe0a9a7.js"><link rel="prefetch" href="/assets/js/17.4697c9db.js"><link rel="prefetch" href="/assets/js/18.babd3f94.js"><link rel="prefetch" href="/assets/js/19.3168d3d7.js"><link rel="prefetch" href="/assets/js/21.116e62cc.js"><link rel="prefetch" href="/assets/js/22.c1a16a7c.js"><link rel="prefetch" href="/assets/js/23.a1aed0ac.js"><link rel="prefetch" href="/assets/js/24.b0a62875.js"><link rel="prefetch" href="/assets/js/25.3ad846cd.js"><link rel="prefetch" href="/assets/js/26.4cdf21f1.js"><link rel="prefetch" href="/assets/js/27.9aad70b3.js"><link rel="prefetch" href="/assets/js/28.6159bc67.js"><link rel="prefetch" href="/assets/js/29.f3205a01.js"><link rel="prefetch" href="/assets/js/30.c6a75514.js"><link rel="prefetch" href="/assets/js/31.5d35c295.js"><link rel="prefetch" href="/assets/js/32.e8a88456.js"><link rel="prefetch" href="/assets/js/33.5763d28a.js"><link rel="prefetch" href="/assets/js/34.eef6dff6.js"><link rel="prefetch" href="/assets/js/35.c55b1d53.js"><link rel="prefetch" href="/assets/js/36.04ec4e4f.js"><link rel="prefetch" href="/assets/js/37.1445889e.js"><link rel="prefetch" href="/assets/js/38.c2369325.js"><link rel="prefetch" href="/assets/js/39.591d4a7a.js"><link rel="prefetch" href="/assets/js/40.8b2243c5.js"><link rel="prefetch" href="/assets/js/41.bd7ec86f.js"><link rel="prefetch" href="/assets/js/42.9aa2497b.js"><link rel="prefetch" href="/assets/js/44.e72dad09.js"><link rel="prefetch" href="/assets/js/45.0c0cf019.js"><link rel="prefetch" href="/assets/js/46.36fe7f81.js"><link rel="prefetch" href="/assets/js/47.5966ce65.js"><link rel="prefetch" href="/assets/js/48.44fd153d.js"><link rel="prefetch" href="/assets/js/49.4c65524f.js"><link rel="prefetch" href="/assets/js/50.e9e1beef.js"><link rel="prefetch" href="/assets/js/51.f67e5993.js"><link rel="prefetch" href="/assets/js/52.51f3a2dd.js"><link rel="prefetch" href="/assets/js/53.25eec254.js"><link rel="prefetch" href="/assets/js/54.3cb3da5d.js"><link rel="prefetch" href="/assets/js/55.659c7163.js"><link rel="prefetch" href="/assets/js/56.658cee8e.js"><link rel="prefetch" href="/assets/js/57.6b9778d2.js"><link rel="prefetch" href="/assets/js/58.37b95470.js"><link rel="prefetch" href="/assets/js/59.de5ddd5f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.32b66682.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" style="position:relative;"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <div class="home-link router-link-active"><img src="/left-logo.png" alt="" class="logo"> <!----></div> <div class="search" style="max-width:-300px;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" placeholder="请输入组件名称" value=""> <!----></div></div> <div class="links" style="max-width:-300px;"><nav class="nav-links can-hide"><div class="nav-item"><a href="/front/git/doc.html" class="nav-link">大前端</a></div><div class="nav-item"><a href="/note/01.html" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/about.html" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front/git/doc.html" class="nav-link">大前端</a></div><div class="nav-item"><a href="/note/01.html" class="nav-link">读书笔记</a></div><div class="nav-item"><a href="/about.html" class="nav-link">关于</a></div> <!----></nav> <!----></div> <div id="area" class="page"> <div class="content"><h1 id="消息推送和行为日志"><a href="#消息推送和行为日志" aria-hidden="true" class="header-anchor">#</a> <div style="display:inline-block;" data-v-90ec2014><img src="" alt data-v-90ec2014></div> 消息推送和行为日志</h1> <h2 id="行为日志（logger）"><a href="#行为日志（logger）" aria-hidden="true" class="header-anchor">#</a> 行为日志（logger）</h2> <p>在诸多 CMS 系统中，权限被分配给用户后，那么就代表这一用户拥有某个权限的绝对控制权。但是有些权限又比较危险，比如删除所有图书这个权限，它很可能直接清除了系统里面的所有图书数据，这显然是一个危险的操作。那么这么危险的操作，如果发生了，作为管理员你该怎么办了。很简单，找到该用户，并禁用该用户，随后联系开发者，恢复数据。</p> <p>logger 主要用来解决这一类的问题，当然你可以将记录任何你觉得敏感的操作，比如某用户访问了某私密数据。接下来，我们来实操一下 logger 的使用。</p> <p>我们修改<code>get_book</code>这个视图函数为：</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> lin<span class="token punctuation">.</span>log <span class="token keyword">import</span> Logger
<span class="token comment"># 省略诸多代码</span>
@book_api<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/&lt;id&gt;'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
@Logger<span class="token punctuation">(</span>template<span class="token operator">=</span><span class="token string">'某用户查询了一本图书'</span><span class="token punctuation">)</span> <span class="token comment"># 推送的消息</span>
<span class="token keyword">def</span> <span class="token function">get_book</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    book <span class="token operator">=</span> Book<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> book <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> NotFound<span class="token punctuation">(</span>msg<span class="token operator">=</span><span class="token string">'没有找到相关书籍'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span>book<span class="token punctuation">)</span>
</code></pre></div><p>接下来，当有任何用户请求这个 API 时，均会在数据库中写入一条日志信息。该日志信息的数据模型的定义在<code>lin.core</code>中，对应的数据表名为<code>lin_log</code>。</p> <p>但有时，<em>某用户查询了一本图书</em>这样的信息未免显得太过于单薄，它无法很好的向前端说明更多的信息。因此 Lin 提供了一个简单的模板语法，你可以在<code>template</code>这个参数中，写入一些变量，如<code>{user.nickname}查询了一本图书</code>，请记住每一个<code>{}</code>中就可以写入一个变量，<code>user.nickname</code>就表示当前用户的昵称。如下：</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> lin<span class="token punctuation">.</span>log <span class="token keyword">import</span> Logger
<span class="token keyword">from</span> lin <span class="token keyword">import</span> route_meta<span class="token punctuation">,</span> group_required<span class="token punctuation">,</span> login_required
<span class="token comment"># 省略诸多代码</span>
@book_api<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/&lt;id&gt;'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
@Logger<span class="token punctuation">(</span>template<span class="token operator">=</span><span class="token string">'{user.nickname}查询了一本图书'</span><span class="token punctuation">)</span> <span class="token comment"># 推送的消息</span>
@login_required <span class="token comment"># 必须，如果用户不登陆，就没有user这个实例</span>
<span class="token keyword">def</span> <span class="token function">get_book</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    book <span class="token operator">=</span> Book<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> book <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> NotFound<span class="token punctuation">(</span>msg<span class="token operator">=</span><span class="token string">'没有找到相关书籍'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span>book<span class="token punctuation">)</span>
</code></pre></div><p>此时，你每请求一次这个 API，它就会在数据中写下下面类似的信息（请注意，这个 API 现在请求必须登陆）。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>+----+---------------------+---------------------+---------+-----------+-------------+--------+------------+-----------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> message             <span class="token operator">|</span> <span class="token function">time</span>                <span class="token operator">|</span> user_id <span class="token operator">|</span> user_name <span class="token operator">|</span> status_code <span class="token operator">|</span> method <span class="token operator">|</span> path       <span class="token operator">|</span> authority <span class="token operator">|</span>
+----+---------------------+---------------------+---------+-----------+-------------+--------+------------+-----------+
<span class="token operator">|</span>  1 <span class="token operator">|</span> pedro查询了一本图书 <span class="token operator">|</span> 2018-10-24 18:11:40 <span class="token operator">|</span>       4 <span class="token operator">|</span> pedro     <span class="token operator">|</span>         200 <span class="token operator">|</span> GET    <span class="token operator">|</span> /v1/book/1 <span class="token operator">|</span>           <span class="token operator">|</span>
+----+---------------------+---------------------+---------+-----------+-------------+--------+------------+-----------+
1 row <span class="token keyword">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span>0.13 sec<span class="token punctuation">)</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>如果你此时请求，发现<code>没有找到相关书籍</code>的异常时，请不要惊慌，因为在前面的教程中，我们确实通过软删除删除了所有的图书数据
所以此时你有两种选择：
一、前往数据库将 delete_time 置为 NULL。
二、在 filter_by 函数中，将 soft 参数置为 False，如<code>Book.query.filter_by(soft=False,id=id).first()</code>。</p></div> <p>我们的模板语法，不仅仅可以在其中嵌入<code>user</code>这个实例，你还可以嵌入 Flask Response 的任何属性，如：<code>response.status</code>，还有 Flask Request 的诸多属性，如<code>request.url</code>。</p> <table><thead><tr><th>name</th> <th style="text-align:center">说明</th> <th style="text-align:center">类型</th></tr></thead> <tbody><tr><td>user</td> <td style="text-align:center">user_model 实例</td> <td style="text-align:center">object</td></tr> <tr><td>response</td> <td style="text-align:center">Flask Response 实例</td> <td style="text-align:center">object</td></tr> <tr><td>request</td> <td style="text-align:center">Flask Request 实例</td> <td style="text-align:center">object</td></tr></tbody></table> <p>这一切取决于你的需求，关于 user 的所有属性，请阅读 user_model 中的所有属性，response 和 request 的所有属性，请阅读<a href="http://flask.pocoo.org/docs/1.0/api/#response-objects" target="_blank" rel="noopener noreferrer">Response<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，<a href="http://flask.pocoo.org/docs/1.0/api/#incoming-request-data" target="_blank" rel="noopener noreferrer">Request<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="消息推送（notify）"><a href="#消息推送（notify）" aria-hidden="true" class="header-anchor">#</a> 消息推送（notify）</h2> <p>notify 是一种消息推送的解决方案，它基于 SSE（Server Sent Events）,关于 SSE 你可以简单的理解为它是一种类 Websocket 的通信方式，
具体细节请你阅读<a href="https://developer.mozilla.org/zh-CN/docs/Server-sent_events/EventSource" target="_blank" rel="noopener noreferrer">MDN 官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>notify 主要用来解决服务器向前端推送消息，例如当购物小程序中，某用户配送一件商品，这是服务器向 CMS 前端推送该消息，然后管理员看到消息通知配送员配送。
接下来，我们来实操一下 notify 插件的使用。</p> <p>我们再次修改<code>get_book</code>这个视图函数为：</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> lin<span class="token punctuation">.</span>log <span class="token keyword">import</span> Logger
<span class="token keyword">from</span> lin<span class="token punctuation">.</span>notify <span class="token keyword">import</span> Notify
<span class="token comment"># 省略代码。。。</span>
@book_api<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/&lt;id&gt;'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
@Logger<span class="token punctuation">(</span>template<span class="token operator">=</span><span class="token string">'{user.nickname}查询了一本图书'</span><span class="token punctuation">)</span>
@Notify<span class="token punctuation">(</span>template<span class="token operator">=</span><span class="token string">'{user.nickname}查询了一本图书'</span><span class="token punctuation">,</span> event<span class="token operator">=</span><span class="token string">'queryBook'</span><span class="token punctuation">)</span> <span class="token comment"># template与Logger的template的用法一样，但必须多传入一个参数event</span>
@login_required
<span class="token keyword">def</span> <span class="token function">get_book</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    book <span class="token operator">=</span> Book<span class="token punctuation">.</span>query<span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span><span class="token builtin">id</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> book <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> NotFound<span class="token punctuation">(</span>msg<span class="token operator">=</span><span class="token string">'没有找到相关书籍'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span>book<span class="token punctuation">)</span>
</code></pre></div><p>在 Notify 的构造函数中你可以传入诸多参数，其中<code>template</code>与<code>event</code>为必传，template 的用法与 Logger 的 template 用法完全一致，而 event 为当前推送事件的名称。</p> <p>你可能会奇怪，为什么需要多加一个 event 参数，因为对于 CMS 来说，管理员需要决定某些用户可接受的推送消息，有一些消息只能推送到某些人。因此请开发者你谨慎使用 event 这个属性，因为有些推送消息不能让某些人知道。</p> <p>接下来，当任何用户访问该 API 时，CMS 前端便可以接受到一条推送消息，关于真正的实现效果，<a href>参考</a>。</p> <div data-v-245db05e><ul class="rightMenuWrapper" data-v-245db05e></ul></div></div> <div class="page-edit"><!----> <!----></div> <!----> <div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div></div> <!----> <img src="" style="position:absolute;width:135px;left:calc(100% / 2 + 50px);bottom:10px;transform:translateX(-50%);"></div></div>
    <script src="/assets/js/43.70b2f705.js" defer></script><script src="/assets/js/5.4adea544.js" defer></script><script src="/assets/js/app.3184a6a2.js" defer></script>
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?c3446600de53c605ba4f6c792e47dff9";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  </body>
</html>
